<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页</title>

    <link rel="shortcut icon" href="favicon.ico"> <link href="/static/admin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/static/admin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/static/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="/static/admin/css/animate.css" rel="stylesheet">
    <link href="/static/admin/css/style.css?v=4.1.0" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/admin/css/wangEditor.min.css">
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>添加文章</h5>
                        <div class="ibox-tools">
                            <button class="btn btn-info btn-xs" data-toggle="modal" data-target="#topModal">添加顶级分类</button>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <!--树形菜单-->
                        <div class="dd" id="nestable">
                            <ol class="dd-list">
                                <?line.forEach(function(item){?>
                                <li class="dd-item dd_top" data-id="<?=item.id?>" data-path="<?=item.path?>" data-order="<?=item.orders?>">
                                    <div class="dd-handle">
                                        <span class="list_name"><?=item.name?></span>
                                        <div class="ibox-tools">
                                            <button style="margin-bottom:0;" class="btn btn-info btn-xs alterTop" type="button" data-toggle="modal" data-target="#alterTopModal" data-id="<?=item.id?>">
                                                <i class="fa fa-paste"></i>
                                                编辑
                                            </button>
                                            <button style="margin-bottom:0;" class="btn btn-primary btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=item.id?>" data-type="add">
                                                <i class="fa fa-check"></i>
                                                添加子分类
                                            </button>
                                            <button style="margin-bottom:0;" type="button" class="btn btn-w-m btn-danger btn-xs deleteBtn" data-id="<?=item.id?>">
                                                删除
                                            </button>
                                        </div>
                                    </div>
                                    <ol class="dd-list">
                                        <?item.twoCategory.forEach(function(vl){?>
                                        <li class="dd-item" data-id="<?=vl.id?>" data-path="<?=vl.path?>">
                                            <div class="dd-handle">
                                                <span class="list_name"><?=vl.name?></span>
                                                <div class="ibox-tools">
                                                    <button style="margin-bottom:0;" class="btn btn-info btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=vl.id?>" data-type="editing">
                                                        <i class="fa fa-paste"></i>
                                                        编辑
                                                    </button>
                                                    <button style="margin-bottom:0;" class="btn btn-primary btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=vl.id?>" data-type="add">
                                                        <i class="fa fa-check"></i>
                                                        添加子分类
                                                    </button>
                                                    <button style="margin-bottom:0;" type="button" class="btn btn-w-m btn-danger btn-xs deleteBtn" data-id="<?=vl.id?>">
                                                        删除
                                                    </button>
                                                </div>
                                            </div>
                                            <ol class="dd-list">
                                                <?vl.threeCategory.forEach(function(tl){?>
                                                <li class="dd-item" data-id="<?=tl.id?>" data-path="<?=tl.path?>">
                                                    <div class="dd-handle">
                                                        <span class="list_name"><?=tl.name?></span>
                                                        <div class="ibox-tools">
                                                            <button style="margin-bottom:0;" class="btn btn-info btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=tl.id?>" data-type="editing">
                                                                <i class="fa fa-paste"></i>
                                                                编辑
                                                            </button>
                                                            <button style="margin-bottom:0;" class="btn btn-primary btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=tl.id?>" data-type="add">
                                                                <i class="fa fa-check"></i>
                                                                添加子分类
                                                            </button>
                                                            <button style="margin-bottom:0;" type="button" class="btn btn-w-m btn-danger btn-xs deleteBtn" data-id="<?=tl.id?>">
                                                                删除
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <ol class="dd-list">
                                                        <?tl.fourCategory.forEach(function(fl){?>
                                                            <li class="dd-item" data-id="<?=fl.id?>" data-path="<?=fl.path?>">
                                                                <div class="dd-handle">
                                                                    <span class="list_name"><?=fl.name?></span>
                                                                    <div class="ibox-tools">
                                                                        <button style="margin-bottom:0;" class="btn btn-info btn-xs twoArticle" type="button" data-toggle="modal" data-target="#myModal" data-id="<?=fl.id?>" data-type="editing">
                                                                            <i class="fa fa-paste"></i>
                                                                            编辑
                                                                        </button>
                                                                        <button style="margin-bottom:0;" type="button" class="btn btn-w-m btn-danger btn-xs deleteBtn" data-id="<?=fl.id?>">
                                                                            删除
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        <?})?>
                                                    </ol>
                                                </li>
                                                <?})?>
                                            </ol>
                                        </li>
                                        <?})?>
                                    </ol>
                                </li>
                                <?})?>
                            </ol>
                        </div>
                        <!--end-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 顶级分类 -->
    <div class="modal fade" id="topModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">添加顶级分类</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">分类名称</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="topValue">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="addTop">添加</button>
            </div>
            </div>
        </div>
    </div>

    <!-- 修改顶级分类 -->
    <div class="modal fade" id="alterTopModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">修改顶级分类</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">分类名称</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="altertopValue">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="alterTop">修改</button>
            </div>
            </div>
        </div>
    </div>

    <!-- 添加或修改二级分类 -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document" style="width:90%;">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addTwosTitle">添加二级分类</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">分类名称</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="twoValue">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">简介</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" style="height:110px;" id="twoBrief"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">详情</label>
                        <div class="col-sm-10">
                            <div id="twoContent" style="height:250px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="addTwo">添加</button>
            </div>
            </div>
        </div>
    </div>
    <!-- 全局js -->
    <script src="/static/admin/js/jquery.min.js?v=2.1.4"></script>
    <script src="/static/admin/js/bootstrap.min.js?v=3.3.6"></script>

    <!-- Peity -->
    <script src="/static/admin/js/plugins/peity/jquery.peity.min.js"></script>
    <!-- wang -->
    <script type="text/javascript" src="/static/admin/js/wangEditor.min.js"></script>
    <!--树形菜单-->
    <script type="text/javascript" src="/static/admin/js/jquery.nestable.js"></script>
    <!--初始化富文本编辑器-->
    <script type="text/javascript">
        var editor = new wangEditor('twoContent');
        //关闭js过滤
        editor.config.jsFilter = false;
        //创建富文本编辑器
        editor.create();
    </script>
    <script>
        $(document).ready(function(){
            //初始化树形菜单
            $('#nestable').nestable({
                maxDepth : 4
            });
            //树形菜单默认展开状态
            //$("#nestable").nestable('collapseAll');
            //屏蔽树形菜单点击事件
            $('.dd-handle button').on('mousedown', function(e){
                e.stopPropagation();
            });
            $('#nestable').nestable().on('change', function(){ 
                var r = $('.dd').nestable('serialize'); 
                var orderContent = JSON.stringify(r);
                console.log(orderContent)
                $.ajax({
                    type : 'POST',
                    url : '/admin/article/setorder',
                    data : {
                        content : orderContent
                    },
                    success : function(data){
                        if(data.errno == 0){
                            alert("更新成功");
                        } else {
                            alert("更新失败");
                        }
                    }
                })
            });
            //添加顶级分类
            $("#addTop").on("click",function(){
                var topValue = $("#topValue").val();
                $.ajax({
                    type : 'POST',
                    url :'/admin/article/addtoparticle',
                    data : {
                        cts : topValue
                    },
                    success : function(data){
                        if(data.errno != 0){
                            alert("添加失败");
                        } else {
                            location.reload();
                        }
                    }
                });
            });

            //添加二级分类
            $(".twoArticle").on("click",function(){
                var tsType = $(this).data("type");
                var tsId = $(this).data("id");
                $("#addTwo").unbind("click");
                editor.$txt.html('');
                $("#twoValue").val("");
                $("#twoBrief").val("");

                if(tsType == 'editing'){
                    $("#addTwosTitle").html("编辑");
                    $("#addTwo").html("保存");
                    $.ajax({
                        type : 'POST',
                        url : '/admin/article/getcontent',
                        data : {
                            id : tsId
                        },
                        success : function(data){
                            if(data.errno==0){
                                $("#twoValue").val(data.data.title.name);
                                $("#twoBrief").val(data.data.title.brief);
                                editor.$txt.append(data.data.cont.content);
                                $("#addTwo").on("click",function(){
                                    var twoValue = $("#twoValue").val();
                                    var twoBrief = $("#twoBrief").val();
                                    var twoContent = editor.$txt.html();
                                    $.ajax({
                                        type : 'POST',
                                        url : '/admin/article/editing',
                                        data : {
                                            cts : twoValue,
                                            br : twoBrief,
                                            content : twoContent,
                                            path : tsId
                                        },
                                        success : function(data){
                                            if(data.errno != 0){
                                                alert("添加失败");
                                            } else {
                                                location.reload();
                                            }
                                        }
                                    });
                                });
                            } else {
                                alert("获取数据错误");
                            }
                        }
                    });
                } else if(tsType == 'add'){
                    $("#addTwosTitle").html("添加二级分类");
                    $("#addTwo").html("添加");
                    $("#addTwo").on("click",function(){
                        var twoValue = $("#twoValue").val();
                        var twoBrief = $("#twoBrief").val();
                        var twoContent = editor.$txt.html();
                        $.ajax({
                            type : 'POST',
                            url : '/admin/article/addtwoarticle',
                            data : {
                                cts : twoValue,
                                br : twoBrief,
                                content : twoContent,
                                path : tsId
                            },
                            success : function(data){
                                if(data.errno != 0){
                                    alert("添加失败");
                                } else {
                                    location.reload();
                                }
                            }
                        });
                    });
                }
            });

            //修改顶级分类
            $(".alterTop").on("click",function(){
                $("#altertopValue").val("");
                $("#alterTop").unbind("click");
                var alterId  = $(this).data("id");
                var alterVal = $(this).parent().parent().find(".list_name").text();
                $("#altertopValue").val(alterVal);
                $("#alterTop").on("click",function(){
                    var alterC = $("#altertopValue").val();
                    $.ajax({
                        type : 'POST',
                        url : '/admin/article/altertop',
                        data : {
                            id : alterId,
                            data : alterC
                        },
                        success : function(data){
                            if(data.errno != 0){
                                alert("修改失败");
                            } else {
                                location.reload();
                            }
                        }
                    });
                });
            });
            //删除
            $(".deleteBtn").on("click",function(){
                var tsId = $(this).data("id");
                location.href = '/admin/article/deletearticle?id=' + tsId;
            });
        });
    </script>
</body>
</html>